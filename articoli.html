<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAA7VBMVEVHcEz26yb3wyr1wirXsjf3wyn7xCf4wSP9xSX3wST3wibrvi7Kqjb7wyPasjP6zSHNqjL4wiWwoVDxvyv4wiX6wiS9ozvYsDD2wijhtCzsuyr5wibnui7FsE22nz2so1i7mjP4wSXuvSnNqzW7nzdsbEnXszfDrEi+nTX7wiK4nzmYjUKsnEmhmFG1pE3mui/hsym8p0qLjVrFq0TSsjzNrDWclVONiEe+pkTLqTGrmD/puCjHpjTctTWGe0LasS1aWUpHTE6EdD/Loy6clFCun0uSkFWkiTeVgTxLT083QlNoYUYnNVd9cULApDmfU3NVAAAAKXRSTlMAAh4mE0NZ/XHrihd23zkM67/HL6PVTcVNzvK55yjUlf7FhGD67vqloacts4KwAAADESURBVBjTTY/VFoJQEEXpUlRQ7O576TLAwG7//3MUuS7db2evWWdmMOwNTjMZCvuRSvNsrsLh35yXFpo9mVWLKFMd4OoB1PelFBrgl1oYqNNJnUxEr3/UoGpMnSbqFVjDDFXtMBSSjBeA68O5uhqMORKJpWMBuLpuLYWODc0vdNuE4Tm67RQiNuk56xmOa23uF4uJBVEDADx1b7uJdtynlxQB8H1jfXq0mWRTWRJza882ZzKBzs8Sma4wklsN7B88G//7Avz1F6mL7PiSAAAAAElFTkSuQmCC">
    <title>Tutti gli Articoli - Giornale Cesaris</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .articles-header {
            text-align: center;
            padding: 3rem 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            margin-bottom: 2rem;
        }
        
        .articles-header h1 {
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .filters-bar {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .filter-select {
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            background: white;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
        }
        
        .search-input {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-full);
            font-family: var(--font-body);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .results-info {
            color: var(--neutral);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .filters-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <span class="logo-icon">üì∞</span>
                    <span>Giornale Cesaris</span>
                </a>
                
                <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
                    <span>‚ò∞</span>
                </button>
                
                <nav>
                    <ul class="nav-menu" id="navMenu">
                        <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
                        <li class="nav-item"><a href="articoli.html" class="nav-link active">Articoli</a></li>
                        <li class="nav-item"><a href="categorie.html" class="nav-link">Categorie</a></li>
                        <li class="nav-item"><a href="chat.html" class="nav-link">Chat</a></li>
                        <li class="nav-item"><a href="profilo.html" class="nav-link">Profilo</a></li>
                        <li class="nav-item"><a href="login.html" class="btn btn-primary btn-sm">Login</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="articles-header">
        <h1>üì∞ Tutti gli Articoli</h1>
        <p>Esplora tutte le storie del Giornale Cesaris</p>
    </div>

    <main class="container">
        <!-- Filters -->
        <div class="filters-bar">
            <div class="filter-group">
                <label for="categoryFilter"><strong>Categoria:</strong></label>
                <select id="categoryFilter" class="filter-select">
                    <option value="all">Tutte</option>
                    <option value="Attualit√†">Attualit√†</option>
                    <option value="Sport">Sport</option>
                    <option value="Cultura">Cultura</option>
                    <option value="Tecnologia">Tecnologia</option>
                    <option value="Scienza">Scienza</option>
                    <option value="Viaggi">Viaggi</option>
                    <option value="Orientamento">Orientamento</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="sortFilter"><strong>Ordina per:</strong></label>
                <select id="sortFilter" class="filter-select">
                    <option value="date">Pi√π Recenti</option>
                    <option value="views">Pi√π Visti</option>
                    <option value="title">Titolo A-Z</option>
                </select>
            </div>
            
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç Cerca articoli...">
            </div>
        </div>

        <!-- Results Info -->
        <div class="results-info" id="resultsInfo">
            Mostrando tutti gli articoli
        </div>

        <!-- Articles Grid -->
        <div class="articles-grid" id="articlesGrid">
            <!-- Articles will be loaded here -->
        </div>

        <!-- Pagination -->
        <nav class="pagination" id="pagination">
            <!-- Pagination will be generated dynamically -->
        </nav>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Giornale Cesaris</h4>
                    <p>Il portale ufficiale del giornale scolastico del Cesaris.</p>
                </div>
                
                <div class="footer-section">
                    <h4>Link Rapidi</h4>
                    <ul class="footer-links">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="candidatura.html">Diventa Reporter</a></li>
                        <li><a href="guidelines.html">Linee Guida</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 Giornale Scolastico Cesaris. Tutti i diritti riservati.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase-api.js"></script>
    <script src="js/main.js"></script>
    <script src="js/articles.js"></script>
    <script>
        let filteredArticles = [];
        let allArticles = [];
        let currentPage = 1;
        const articlesPerPage = 9;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadArticlesFromSupabase();
            
            // Check for URL parameters (category, tag)
            const urlParams = new URLSearchParams(window.location.search);
            const categoryParam = urlParams.get('categoria');
            const tagParam = urlParams.get('tag');
            
            if (categoryParam) {
                document.getElementById('categoryFilter').value = categoryParam;
                document.querySelector('.articles-header h1').textContent = `üì∞ Articoli: ${categoryParam}`;
            }
            
            if (tagParam) {
                document.getElementById('searchInput').value = tagParam;
                document.querySelector('.articles-header h1').textContent = `üì∞ Articoli con tag: #${tagParam}`;
            }
            
            filterArticles();
            setupFilters();
        });
        
        // Load articles from Supabase
        async function loadArticlesFromSupabase() {
            if (window.SupabaseAPI) {
                const result = await window.SupabaseAPI.getArticles({ limit: 1000 });
                if (result.success && result.data) {
                    allArticles = result.data;
                    filteredArticles = [...allArticles];
                } else {
                    console.error('Error loading articles:', result.error);
                    allArticles = [];
                    filteredArticles = [];
                }
            } else {
                console.error('SupabaseAPI not initialized');
                allArticles = [];
                filteredArticles = [];
            }
        }
        
        function setupFilters() {
            // Category filter
            document.getElementById('categoryFilter').addEventListener('change', (e) => {
                filterArticles();
            });
            
            // Sort filter
            document.getElementById('sortFilter').addEventListener('change', (e) => {
                filterArticles();
            });
            
            // Search input
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterArticles();
                }, 300);
            });
        }
        
        function filterArticles() {
            const category = document.getElementById('categoryFilter').value;
            const sortBy = document.getElementById('sortFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            // Start with all articles
            let articles = [...allArticles];
            
            // Filter by category
            if (category !== 'all') {
                articles = articles.filter(a => a.categoria === category);
            }
            
            // Filter by search
            if (searchQuery) {
                articles = articles.filter(a => 
                    a.titolo.toLowerCase().includes(searchQuery) ||
                    a.sommario.toLowerCase().includes(searchQuery) ||
                    a.contenuto.toLowerCase().includes(searchQuery)
                );
            }
            
            // Sort
            switch (sortBy) {
                case 'date':
                    articles.sort((a, b) => new Date(b.data_pubblicazione) - new Date(a.data_pubblicazione));
                    break;
                case 'views':
                    articles.sort((a, b) => b.visualizzazioni - a.visualizzazioni);
                    break;
                case 'title':
                    articles.sort((a, b) => a.titolo.localeCompare(b.titolo));
                    break;
            }
            
            filteredArticles = articles;
            currentPage = 1;
            displayArticles();
            updateResultsInfo();
        }
        
        function displayArticles() {
            const startIndex = (currentPage - 1) * articlesPerPage;
            const endIndex = startIndex + articlesPerPage;
            const articlesToShow = filteredArticles.slice(startIndex, endIndex);
            
            const container = document.getElementById('articlesGrid');
            container.innerHTML = '';
            
            if (articlesToShow.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--neutral);"><h3>Nessun articolo trovato</h3><p>Prova a modificare i filtri di ricerca</p></div>';
                return;
            }
            
            articlesToShow.forEach(article => {
                const card = createArticleCard(article);
                container.appendChild(card);
            });
            
            updatePagination();
        }
        
        function createArticleCard(article) {
            const card = document.createElement('div');
            card.className = 'card fade-in';
            card.style.cursor = 'pointer';
            
            const date = new Date(article.data_pubblicazione || article.created_at);
            const formattedDate = date.toLocaleDateString('it-IT', { 
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            const authorName = article.autore?.nome_visualizzato || article.autore?.username || 'Redazione';
            const readingTime = article.reading_time_minutes || 5;
            const views = article.visualizzazioni || 0;
            const imageSrc = article.immagine_url || article.immagine || createPlaceholderImage(article.categoria);
            const articleUrl = `articolo.html?id=${article.id}`;
            
            card.innerHTML = `
                <a href="${articleUrl}" style="text-decoration: none; color: inherit; display: block;">
                    <img src="${imageSrc}" 
                         alt="${escapeHtml(article.titolo)}" 
                         class="card-img"
                         onerror="this.src='${createPlaceholderImage(article.categoria)}'">
                    <div class="card-body">
                        <span style="font-size: 0.875rem; color: var(--primary); font-weight: 600; text-transform: uppercase; display: block; margin-bottom: 0.5rem;">${escapeHtml(article.categoria)}</span>
                        <h3 class="card-title">${escapeHtml(article.titolo)}</h3>
                        <p class="card-text">${truncateText(escapeHtml(article.sommario || ''), 120)}</p>
                        <div class="card-meta">
                            <span>üë§ ${escapeHtml(authorName)}</span>
                            <span>üìÖ ${formattedDate}</span>
                            <span>üìñ ${readingTime} min</span>
                            <span>üëÅÔ∏è ${views}</span>
                        </div>
                        <span class="btn btn-primary" style="margin-top: 1rem; width: 100%; display: block; text-align: center;">Leggi Articolo</span>
                    </div>
                </a>
            `;
            
            // Make entire card clickable
            card.addEventListener('click', (e) => {
                if (e.target.tagName !== 'A') {
                    window.location.href = articleUrl;
                }
            });
            
            return card;
        }
        
        // Escape HTML helper
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function updatePagination() {
            const totalPages = Math.ceil(filteredArticles.length / articlesPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            pagination.innerHTML = '';
            
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.className = 'page-num';
                button.textContent = i;
                button.dataset.page = i;
                
                if (i === currentPage) {
                    button.classList.add('active');
                }
                
                button.addEventListener('click', () => {
                    currentPage = i;
                    displayArticles();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                
                pagination.appendChild(button);
            }
        }
        
        function updateResultsInfo() {
            const info = document.getElementById('resultsInfo');
            const total = filteredArticles.length;
            const category = document.getElementById('categoryFilter').value;
            const searchQuery = document.getElementById('searchInput').value;
            
            let text = `Mostrando ${total} articol${total === 1 ? 'o' : 'i'}`;
            
            if (category !== 'all') {
                text += ` nella categoria "${category}"`;
            }
            
            if (searchQuery) {
                text += ` per "${searchQuery}"`;
            }
            
            info.textContent = text;
        }
        
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        function createPlaceholderImage(category) {
            const colors = {
                'Attualit√†': '#0033A0',
                'Sport': '#10B981',
                'Cultura': '#EC4899',
                'Tecnologia': '#FFD700',
                'Scienza': '#6366F1',
                'Viaggi': '#F59E0B',
                'Orientamento': '#8B5CF6',
                'default': '#6B7280'
            };
            
            const emoji = {
                'Attualit√†': 'üì∞',
                'Sport': '‚öΩ',
                'Cultura': 'üé≠',
                'Tecnologia': 'üíª',
                'Scienza': 'üî¨',
                'Viaggi': '‚úàÔ∏è',
                'Orientamento': 'üéì',
                'default': 'üìù'
            };
            
            const color = colors[category] || colors.default;
            const icon = emoji[category] || emoji.default;
            
            const svg = `
                <svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
                    <rect width="400" height="300" fill="${color}"/>
                    <text x="50%" y="50%" font-size="80" text-anchor="middle" dy=".3em">${icon}</text>
                </svg>
            `;
            
            return `data:image/svg+xml,${encodeURIComponent(svg)}`;
        }
    </script>
</body>
</html>
