<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Giornale Scolastico Cesaris - Il tuo portale di notizie scolastiche">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAA7VBMVEVHcEz26yb3wyr1wirXsjf3wyn7xCf4wSP9xSX3wST3wibrvi7Kqjb7wyPasjP6zSHNqjL4wiWwoVDxvyv4wiX6wiS9ozvYsDD2wijhtCzsuyr5wibnui7FsE22nz2so1i7mjP4wSXuvSnNqzW7nzdsbEnXszfDrEi+nTX7wiK4nzmYjUKsnEmhmFG1pE3mui/hsym8p0qLjVrFq0TSsjzNrDWclVONiEe+pkTLqTGrmD/puCjHpjTctTWGe0LasS1aWUpHTE6EdD/Loy6clFCun0uSkFWkiTeVgTxLT083QlNoYUYnNVd9cULApDmfU3NVAAAAKXRSTlMAAh4mE0NZ/XHrihd23zkM67/HL6PVTcVNzvK55yjUlf7FhGD67vqloacts4KwAAADESURBVBjTTY/VFoJQEEXpUlRQ7O576TLAwG7//3MUuS7db2evWWdmMOwNTjMZCvuRSvNsrsLh35yXFpo9mVWLKFMd4OoB1PelFBrgl1oYqNNJnUxEr3/UoGpMnSbqFVjDDFXtMBSSjBeA68O5uhqMORKJpWMBuLpuLYWODc0vdNuE4Tm67RQiNuk56xmOa23uF4uJBVEDADx1b7uJdtynlxQB8H1jfXq0mWRTWRJza882ZzKBzs8Sma4wklsN7B88G//7Avz1F6mL7PiSAAAAAElFTkSuQmCC">
    <title>Giornale Scolastico Cesaris</title>
<!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Global Page Loader -->
    <div class="page-loader" id="page-loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">Caricamento pagina...</div>
    </div>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAA7VBMVEVHcEz26yb3wyr1wirXsjf3wyn7xCf4wSP9xSX3wST3wibrvi7Kqjb7wyPasjP6zSHNqjL4wiWwoVDxvyv4wiX6wiS9ozvYsDD2wijhtCzsuyr5wibnui7FsE22nz2so1i7mjP4wSXuvSnNqzW7nzdsbEnXszfDrEi+nTX7wiK4nzmYjUKsnEmhmFG1pE3mui/hsym8p0qLjVrFq0TSsjzNrDWclVONiEe+pkTLqTGrmD/puCjHpjTctTWGe0LasS1aWUpHTE6EdD/Loy6clFCun0uSkFWkiTeVgTxLT083QlNoYUYnNVd9cULApDmfU3NVAAAAKXRSTlMAAh4mE0NZ/XHrihd23zkM67/HL6PVTcVNzvK55yjUlf7FhGD67vqloacts4KwAAADESURBVBjTTY/VFoJQEEXpUlRQ7O576TLAwG7//3MUuS7db2evWWdmMOwNTjMZCvuRSvNsrsLh35yXFpo9mVWLKFMd4OoB1PelFBrgl1oYqNNJnUxEr3/UoGpMnSbqFVjDDFXtMBSSjBeA68O5uhqMORKJpWMBuLpuLYWODc0vdNuE4Tm67RQiNuk56xmOa23uF4uJBVEDADx1b7uJdtynlxQB8H1jfXq0mWRTWRJza882ZzKBzs8Sma4wklsN7B88G//7Avz1F6mL7PiSAAAAAElFTkSuQmCC" alt="Logo Cesaris" class="logo-image" style="height: 2rem; width: auto; margin-right: 0.5rem;">
                  <span>Giornale Cesaris</span>
                </a>
                
                <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
                    <span>‚ò∞</span>
                </button>
                
                <nav>
                    <ul class="nav-menu" id="navMenu">
                        <li class="nav-item"><a href="index.html" class="nav-link active">Home</a></li>
                        <li class="nav-item"><a href="articoli.html" class="nav-link">Articoli</a></li>
                        <li class="nav-item"><a href="categorie.html" class="nav-link">Categorie</a></li>
                        <li class="nav-item"><a href="chat.html" class="nav-link">Chat</a></li>
                        <li class="nav-item"><a href="profilo.html" class="nav-link">Profilo</a></li>
                        <!-- Auth buttons will be added dynamically by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Reporter Quick Access (only for reporters) -->
    <section id="reporterQuickAccess" style="display: none; margin: 2rem auto; max-width: 1200px; padding: 0 1rem;">
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 2rem; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h2 style="color: white; margin-bottom: 1rem; font-size: 1.5rem;">‚úçÔ∏è Sei un Reporter!</h2>
            <p style="margin-bottom: 1.5rem; color: #f0fdf4;">Crea e pubblica i tuoi articoli direttamente dalla dashboard</p>
            <a href="dashboard.html" class="btn" style="background: white; color: #059669; padding: 0.75rem 2rem; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-block;">
                üìù Scrivi un Nuovo Articolo
            </a>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container">
        <!-- Articles Grid -->
        <section class="articles-grid" id="articlesGrid">
            <!-- Articles will be loaded dynamically -->
        </section>

        <!-- Pagination -->
        <nav class="pagination" id="pagination">
            <!-- Pagination buttons will be generated dynamically -->
        </nav>

        <!-- Daily Quote -->
        <section class="card" style="margin: 2rem 0; padding: 2rem; text-align: center;">
            <h4 style="color: var(--primary); margin-bottom: 1rem;">‚ú® Frase del Giorno</h4>
            <p id="dailyQuote" style="font-size: 1.25rem; font-style: italic; color: var(--neutral);"></p>
        </section>

        <!-- Trending Articles -->
        <section style="margin: 3rem 0;">
            <h2 style="text-align: center; margin-bottom: 2rem; color: var(--primary);">üî• Articoli di Tendenza</h2>
            <div class="grid grid-3" id="trendingGrid">
                <!-- Trending articles will be loaded here -->
            </div>
        </section>
        
        <!-- Top Writers Widget -->
        <section class="top-writers-section" style="margin: 3rem 0;">
            <h2 style="text-align: center; margin-bottom: 2rem; color: var(--primary);">üèÜ Top 3 Scrittori</h2>
            <div id="topWritersWidget" class="top-writers-widget">
                <div style="text-align: center; padding: 2rem; color: var(--neutral);">
                    <p>Caricamento classifica...</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Chat Bubble -->
    <div class="chat-bubble" id="chatBubble" title="Apri Chat">
        üí¨
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Giornale Cesaris</h4>
                    <p>Il portale ufficiale del giornale scolastico del Cesaris.</p>
                    <p>üìç Casalpusterlengo, Italia</p>
                </div>
                
                <div class="footer-section">
                    <h4>Link Rapidi</h4>
                    <ul class="footer-links">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="articoli.html">Tutti gli Articoli</a></li>
                        <li><a href="candidatura.html">Diventa Reporter</a></li>
                        <li><a href="guidelines.html">Linee Guida Community</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Informazioni</h4>
                    <ul class="footer-links">
                        <li><a href="about.html">Chi Siamo</a></li>
                        <li><a href="privacy.html">Privacy Policy</a></li>
                        <li><a href="terms.html">Termini di Servizio</a></li>
                        <li><a href="contact.html">Contatti</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>La Nostra Scuola</h4>
                    <ul class="footer-links">
                        <li>
                            <a href="https://cesaris.edu.it/" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                üè´ IIS Cesaris - Sito Ufficiale
                            </a>
                        </li>
                    </ul>
                    <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
                        Istituto d'Istruzione Superiore "G. Cesaris"<br>
                        Casalpusterlengo (LO)
                    </p>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 Giornale Scolastico Cesaris. Tutti i diritti riservati.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase-api.js"></script>
    <script src="js/main.js"></script>
    <script src="js/articles.js"></script>
    
    <!-- Persistent Login Handler -->
    <script>
        // Check and update navigation based on authentication state
        function updateNavigation() {
            const userId = localStorage.getItem('userId');
            const userEmail = localStorage.getItem('userEmail');
            const userRole = localStorage.getItem('userRole');
            const username = localStorage.getItem('username');
            
            const navMenu = document.getElementById('navMenu');
            if (!navMenu) return;
            
            // Remove existing login/logout buttons
            const existingAuthBtns = navMenu.querySelectorAll('.auth-btn');
            existingAuthBtns.forEach(btn => btn.remove());
            
            if (userId && userEmail) {
                // User is logged in - show logout and dashboard links
                const userLi = document.createElement('li');
                userLi.className = 'nav-item auth-btn';
                userLi.innerHTML = `<span style="color: var(--primary); font-weight: 600;">üë§ ${username || userEmail.split('@')[0]}</span>`;
                navMenu.appendChild(userLi);
                
                // Add dashboard link based on role
                if (userRole === 'reporter' || userRole === 'docente' || userRole === 'caporedattore') {
                    const dashboardLi = document.createElement('li');
                    dashboardLi.className = 'nav-item auth-btn';
                    
                    if (userRole === 'docente' || userRole === 'caporedattore') {
                        dashboardLi.innerHTML = `<a href="admin.html" class="nav-link">‚öôÔ∏è Admin</a>`;
                    } else {
                        dashboardLi.innerHTML = `<a href="dashboard.html" class="nav-link">‚úçÔ∏è Dashboard</a>`;
                    }
                    navMenu.appendChild(dashboardLi);
                    
                    // Show reporter quick access section
                    const reporterQuickAccess = document.getElementById('reporterQuickAccess');
                    if (reporterQuickAccess) {
                        reporterQuickAccess.style.display = 'block';
                    }
                }
                
                // Add logout button
                const logoutLi = document.createElement('li');
                logoutLi.className = 'nav-item auth-btn';
                logoutLi.innerHTML = `<a href="#" class="btn btn-secondary btn-sm" onclick="handleLogout(event)">Logout</a>`;
                navMenu.appendChild(logoutLi);
            } else {
                // User is not logged in - show login button
                const loginLi = document.createElement('li');
                loginLi.className = 'nav-item auth-btn';
                loginLi.innerHTML = `<a href="login.html" class="btn btn-primary btn-sm">Login</a>`;
                navMenu.appendChild(loginLi);
                
                // Add register button
                const registerLi = document.createElement('li');
                registerLi.className = 'nav-item auth-btn';
                registerLi.innerHTML = `<a href="register.html" class="nav-link">Registrati</a>`;
                navMenu.appendChild(registerLi);
            }
        }
        
        // Handle logout
        async function handleLogout(event) {
            event.preventDefault();
            
            if (!confirm('Sei sicuro di voler uscire?')) {
                return;
            }
            
            try {
                // Sign out from Supabase
                await supabase.auth.signOut();
                
                // Clear localStorage
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userRole');
                localStorage.removeItem('username');
                
                // Redirect to home
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                alert('Errore durante il logout');
            }
        }
        
        // Run on page load
        document.addEventListener('DOMContentLoaded', updateNavigation);
    </script>
    
    <!-- Top Writers Widget Script -->
    <script>
        async function loadTopWriters() {
            const widget = document.getElementById('topWritersWidget');
            if (!widget) return;
            
            try {
                // Wait for Supabase
                await new Promise(resolve => setTimeout(resolve, 200));
                
                if (!window.supabaseClient) {
                    widget.innerHTML = '<p style="text-align: center; color: var(--neutral);">Impossibile caricare la classifica</p>';
                    return;
                }
                
                // Get all published articles with author info
                const { data: articles, error } = await window.supabaseClient
                    .from('articoli')
                    .select(`
                        autore_id,
                        visualizzazioni,
                        autore:profili_utenti!fk_articoli_autore(id, username, nome_visualizzato)
                    `)
                    .eq('stato', 'pubblicato');
                
                if (error) throw error;
                
                if (!articles || articles.length === 0) {
                    widget.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--neutral);">
                            <p>Nessun articolo pubblicato ancora. Sii il primo!</p>
                        </div>
                    `;
                    return;
                }
                
                // Aggregate views by author
                const authorStats = {};
                articles.forEach(article => {
                    const authorId = article.autore_id;
                    const authorName = article.autore?.nome_visualizzato || article.autore?.username || 'Anonimo';
                    const views = article.visualizzazioni || 0;
                    
                    if (!authorStats[authorId]) {
                        authorStats[authorId] = {
                            id: authorId,
                            name: authorName,
                            username: article.autore?.username || 'anonimo',
                            totalViews: 0,
                            articleCount: 0
                        };
                    }
                    
                    authorStats[authorId].totalViews += views;
                    authorStats[authorId].articleCount++;
                });
                
                // Sort by total views and get top 3
                const topWriters = Object.values(authorStats)
                    .sort((a, b) => b.totalViews - a.totalViews)
                    .slice(0, 3);
                
                if (topWriters.length === 0) {
                    widget.innerHTML = '<p style="text-align: center; color: var(--neutral);">Nessun dato disponibile</p>';
                    return;
                }
                
                // Render podium
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const positions = ['gold', 'silver', 'bronze'];
                
                widget.innerHTML = topWriters.map((writer, index) => {
                    const writerName = writer.name || 'Anonimo';
                    const initial = writerName.charAt(0).toUpperCase();
                    const position = positions[index] || 'bronze';
                    const medal = medals[index] || 'üèÖ';
                    const rank = index + 1;
                    
                    // Escape HTML for safety
                    const escapedName = writerName.replace(/[&<>"']/g, (c) => ({
                        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                    }[c]));
                    
                    return `
                        <div class="writer-podium ${position}">
                            <div class="writer-avatar">
                                ${initial}
                                <span class="writer-medal">${medal}</span>
                            </div>
                            <div class="writer-name" title="${escapedName}">${escapedName}</div>
                            <div class="writer-stats">
                                <span>üëÅÔ∏è ${writer.totalViews.toLocaleString()}</span>
                                <span>üìù ${writer.articleCount} articoli</span>
                            </div>
                            <div class="writer-podium-base">${rank}</div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading top writers:', error);
                widget.innerHTML = '<p style="text-align: center; color: var(--neutral);">Errore nel caricamento</p>';
            }
        }
        
        // Load top writers on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadTopWriters, 500);
        });
    </script>
    
    <!-- Page Loader Script -->
    <script>
        window.addEventListener('load', function() {
            const loader = document.getElementById('page-loader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(function() {
                    loader.style.display = 'none';
                }, 300);
            }
        });
        
        // Fallback: remove loader after 10 seconds if load event doesn't fire
        setTimeout(function() {
            const loader = document.getElementById('page-loader');
            if (loader && loader.style.display !== 'none') {
                loader.style.display = 'none';
            }
        }, 10000);
    </script>
</body>
</html>
